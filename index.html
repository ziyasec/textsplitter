<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="UTF-8" />
  <title>Smart Text Splitter</title>
  <!-- Simple Analytics -->
  <script data-collect-dnt="true" async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
  <noscript>
    <img src="https://queue.simpleanalyticscdn.com/noscript.gif?collect-dnt=true" alt="" referrerpolicy="no-referrer-when-downgrade"/>
  </noscript>


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Text Splitter - God-Tier Edition</title>
    <meta name="description" content="Effortlessly split text and code into manageable, intelligent segments. Supports various splitting methods, reordering, and export options.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.yourdomain.app/"> <!-- Update with your actual domain -->
    <meta property="og:title" content="Smart Text Splitter - Divide Text Intelligently">
    <meta property="og:description" content="Effortlessly split any text or code into manageable sections for any platform.">
    <meta property="og:image" content="https://www.yourdomain.app/social-preview.png"> <!-- Create this image -->

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://www.yourdomain.app/"> <!-- Update with your actual domain -->
    <meta property="twitter:title" content="Smart Text Splitter - Divide Text Intelligently">
    <meta property="twitter:description" content="Effortlessly split any text or code into manageable sections for any platform.">
    <meta property="twitter:image" content="https://www.yourdomain.app/social-preview.png">

    <!-- Favicons -->
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png"> <!-- 180x180 -->
    <meta name="theme-color" content="#2563eb"> <!-- Matches primary blue -->

    <!-- Google Fonts: Outfit for headings, Inter for body -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Outfit:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Sortable.js for Drag-to-Reorder -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <!-- Analytics Placeholders (requires deployment and setup) -->
    <!--
    <script defer data-domain="yourdomain.app" src="https://plausible.io/js/script.js"></script>
    -->
    <!--
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-XXXXXXXXXX');
    </script>
    -->

    <style>
        /* Custom styles for the Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif; /* Primary font */
            background-color: #f0f4f8; /* Light background: Zinc 50 */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 4rem 2rem; /* Increased vertical padding for more air */
            box-sizing: border-box;
            color: #27272a; /* Default text color: Zinc 800 */
            transition: background-color 0.3s ease-in-out, color 0.3s ease-in-out;
        }

        /* Dark mode styles */
        .dark body {
            background-color: #18181b; /* Dark background: Zinc 900 */
            color: #e4e4e7; /* Light text: Zinc 200 */
        }
        .dark .container {
            background-color: #27272a; /* Darker card background: Zinc 800 */
            border-color: #3f3f46; /* Dark border: Zinc 700 */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        .dark h1, .dark h3 {
            color: #e4e4e7; /* Zinc 200 */
        }
        .dark .text-gray-600, .dark .text-gray-500, .dark .text-gray-700 {
            color: #a1a1aa; /* Zinc 400 */
        }
        .dark .text-blue-600 {
            color: #60a5fa; /* Lighter blue for dark mode contrast: Blue 400 */
        }
        .dark textarea, .dark input[type="number"], .dark input[type="text"], .dark select {
            background-color: #3f3f46; /* Zinc 700 */
            border-color: #52525b; /* Zinc 600 */
            color: #e4e4e7; /* Zinc 200 */
        }
        .dark pre {
            background-color: #3f3f46; /* Zinc 700 */
            border-color: #52525b; /* Zinc 600 */
            color: #e4e4e7; /* Zinc 200 */
        }
        .dark .bg-gray-50 {
            background-color: #3f3f46; /* Zinc 700 */
        }
        .dark .border-gray-200 {
            border-color: #52525b; /* Zinc 600 */
        }
        .dark .shadow-inner-md {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.2);
        }
        .dark .bg-blue-50 { /* For suggestion box */
            background-color: #1e3a8a; /* Darker blue */
            border-color: #3b82f6;
            color: #bfdbfe;
        }
        .dark .file\:bg-blue-50 {
            background-color: #1e3a8a;
        }
        .dark .file\:text-blue-700 {
            color: #93c5fd;
        }
        .dark .hover\:file\:bg-blue-100:hover {
            background-color: #2563eb;
        }


        /* Applying Outfit to headings for a modern contrast */
        h1, h3 {
            font-family: 'Outfit', sans-serif;
            transition: color 0.3s ease-in-out;
        }

        /* Custom scrollbar for pre tags - optional, but can improve look */
        pre::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        pre::-webkit-scrollbar-thumb {
            background-color: #a1a1aa; /* Zinc 400 */
            border-radius: 4px;
        }
        .dark pre::-webkit-scrollbar-thumb {
            background-color: #52525b; /* Zinc 600 */
        }
        pre::-webkit-scrollbar-track {
            background-color: #e4e4e7; /* Zinc 200 */
            border-radius: 4px;
        }
        .dark pre::-webkit-scrollbar-track {
            background-color: #27272a; /* Zinc 800 */
        }


        /* Subtle gradient for the main button */
        .gradient-button {
            background: linear-gradient(to right bottom, #3b82f6, #2563eb); /* Blue 500 to Blue 700 */
            transition: all 0.3s ease-in-out;
        }
        .gradient-button:hover {
            background: linear-gradient(to right bottom, #2563eb, #1e40af); /* Darker blue on hover */
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.2); /* More pronounced shadow */
        }
        .gradient-button:active {
            transform: translateY(0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .dark .gradient-button {
            background: linear-gradient(to right bottom, #60a5fa, #3b82f6); /* Blue 400 to Blue 500 */
        }
        .dark .gradient-button:hover {
            background: linear-gradient(to right bottom, #3b82f6, #2563eb); /* Darker blue on hover */
        }


        /* Sortable.js ghost and chosen styles */
        .sortable-ghost {
            opacity: 0.2;
            background-color: #dbeafe; /* Blue 100 */
            border: 2px dashed #93c5fd; /* Blue 300 */
        }
        .dark .sortable-ghost {
            background-color: #4a5568; /* Gray 700 */
            border-color: #616e7f; /* Gray 600 */
        }

        /* Fixed position for Dark Mode Toggle and Message Box for mobile friendliness */
        @media (max-width: 640px) {
            body {
                padding: 2rem 1rem;
            }
            .fixed {
                position: fixed;
                bottom: 1rem;
                right: 1rem;
                top: auto; /* Override top-6 for dark mode toggle */
            }
            .gradient-button, .copy-all-button {
                padding: 1rem 1.5rem; /* Make buttons larger on mobile */
                font-size: 1.125rem;
            }
            .space-y-8 > *:not([hidden]) ~ *:not([hidden]) {
                margin-top: 1.5rem !important; /* Adjust spacing for better mobile layout */
            }
            .sm\:space-x-8 > *:not([hidden]) ~ *:not([hidden]) {
                margin-left: 0 !important;
            }
        }

        /* Landing Animations */
        .animate-in-from-top {
            opacity: 0;
            transform: translateY(-20px);
            animation: slideInFromTop 0.8s ease-out forwards;
        }

        .animate-in-from-bottom {
            opacity: 0;
            transform: translateY(20px);
            animation: slideInFromBottom 0.8s ease-out forwards;
        }

        .animate-fade-in {
            opacity: 0;
            animation: fadeIn 1s ease-in forwards;
        }

        /* Delay for sequential animations */
        .headline-sub { animation-delay: 0.2s; }
        .headline-main { animation-delay: 0.4s; }
        .headline-desc { animation-delay: 0.6s; }
        .input-section { animation-delay: 0.8s; }
        .type-suggestion { animation-delay: 1.0s; }
        .template-section { animation-delay: 1.2s; }
        .controls-section { animation-delay: 1.4s; }
        .action-buttons { animation-delay: 1.6s; }


        @keyframes slideInFromTop {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInFromBottom {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-10 bg-white rounded-3xl shadow-2xl max-w-4xl w-full border border-zinc-100 transform transition-transform duration-300 ease-out hover:scale-[1.005]">
        <h1 class="text-5xl md:text-6xl font-extrabold text-center text-zinc-800 mb-6 leading-tight animate-in-from-top headline-main">
            <span class="block text-zinc-600 text-3xl font-normal mb-2 headline-sub">The Ultimate</span>
            Smart <span class="text-blue-600">Text Splitter</span>
        </h1>
        <p class="text-center text-zinc-500 mb-12 text-xl max-w-2xl mx-auto animate-in-from-bottom headline-desc">Effortlessly break down any text or code into perfectly sized, context-aware segments for any purpose.</p>

        <div class="mb-12 animate-fade-in input-section">
            <label for="inputText" class="block text-lg font-medium text-zinc-700 mb-2">Paste your lengthy text or upload a file:</label>
            <textarea id="inputText" rows="12" class="w-full p-6 border-2 border-zinc-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-zinc-800 bg-zinc-50 resize-y text-base shadow-inner-md" placeholder="e.g., A long article, a large code file, a book chapter, or a multi-part message..." aria-label="Main text input for splitting"></textarea>
            <div class="flex justify-between items-center text-sm text-zinc-500 mt-2">
                <span id="charCount">Characters: 0</span>
                <span id="wordCount">Words: 0</span>
                <span id="estimatedPartInfo"></span>
            </div>
            <input type="file" id="fileUpload" class="mt-4 block w-full text-sm text-zinc-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer dark:file:bg-blue-800 dark:file:text-blue-100 dark:hover:file:bg-blue-700 dark:text-zinc-300" aria-label="Upload text file"/>
        </div>

        <!-- Text Type Detection Suggestion -->
        <div id="typeSuggestion" class="bg-blue-50 border border-blue-200 text-blue-800 px-6 py-4 rounded-xl mb-8 hidden animate-fade-in type-suggestion dark:bg-blue-900 dark:border-blue-700 dark:text-blue-200" role="alert">
            <p class="font-semibold">🧠 Intelligent Suggestion:</p>
            <p id="suggestionText"></p>
            <button id="applySuggestion" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400" aria-label="Apply suggested splitting method">Apply Suggestion</button>
        </div>


        <div class="flex flex-col sm:flex-row items-center justify-between mb-8 space-y-8 sm:space-y-0 sm:space-x-8 animate-fade-in template-section">
            <div class="w-full sm:w-auto flex-grow">
                <label for="templateSelector" class="block text-lg font-medium text-zinc-700 mb-2">Use Case Template:</label>
                <select id="templateSelector" class="w-full p-4 border-2 border-zinc-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-zinc-800 bg-zinc-50 text-base shadow-inner-md dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-200" aria-label="Select a use case template">
                    <option value="none">Select a template</option>
                    <option value="twitter-thread">Twitter/X Thread (280 chars)</option>
                    <option value="reddit-post">Reddit Post (by paragraphs)</option>
                    <option value="discord-chunk">Discord Message (~1900 chars)</option>
                    <option value="code-blocks">Code Blocks (by blank lines)</option>
                </select>
            </div>
        </div>

        <div class="flex flex-col sm:flex-row items-center justify-between mb-12 space-y-8 sm:space-y-0 sm:space-x-8 animate-fade-in controls-section">
            <div class="w-full sm:w-auto flex-grow">
                <label for="splitMethod" class="block text-lg font-medium text-zinc-700 mb-2">Split by:</label>
                <select id="splitMethod" class="w-full p-4 border-2 border-zinc-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-zinc-800 bg-zinc-50 text-base shadow-inner-md dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-200" aria-label="Select splitting method">
                    <option value="numParts">Number of Parts (Even Distribution)</option>
                    <option value="maxChars">Max Characters per Part (Word-aware)</option>
                    <option value="sentences">Sentences</option>
                    <option value="paragraphs">Paragraphs</option>
                    <option value="markdownHeaders">Markdown Headers</option>
                    <option value="codeFunctions">Code Functions/Classes</option>
                    <option value="customDelimiter">Custom Delimiter</option>
                </select>
            </div>

            <div class="w-full sm:w-auto flex-grow" id="partsInputGroup">
                <label for="numParts" class="block text-lg font-medium text-zinc-700 mb-2">Number of segments:</label>
                <input type="number" id="numParts" value="2" min="1" class="w-full p-4 border-2 border-zinc-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-zinc-800 bg-zinc-50 text-base shadow-inner-md dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-200" placeholder="e.g., 2, 3, 4" aria-label="Number of segments to split into">
            </div>

            <div class="w-full sm:w-auto flex-grow hidden" id="maxCharsInputGroup">
                <label for="maxChars" class="block text-lg font-medium text-zinc-700 mb-2">Max characters per part:</label>
                <input type="number" id="maxChars" value="1000" min="10" class="w-full p-4 border-2 border-zinc-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-zinc-800 bg-zinc-50 text-base shadow-inner-md dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-200" placeholder="e.g., 500, 1000" aria-label="Maximum characters per part">
            </div>

            <div class="w-full sm:w-auto flex-grow hidden" id="customDelimiterInputGroup">
                <label for="customDelimiter" class="block text-lg font-medium text-zinc-700 mb-2">Custom Delimiter:</label>
                <input type="text" id="customDelimiter" class="w-full p-4 border-2 border-zinc-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-500 text-zinc-800 bg-zinc-50 text-base shadow-inner-md dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-200" placeholder="e.g., '---', ';;', '[SECTION]' " aria-label="Custom delimiter for splitting">
            </div>

            <button id="splitButton" class="w-full sm:w-auto px-12 py-6 gradient-button text-white font-bold rounded-2xl shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300 focus:ring-offset-2 text-xl transform animate-in-from-bottom action-buttons" aria-label="Split text now">
                ⚡ Split Text!
            </button>
        </div>

        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mb-10">
            <button id="copyAllButton" class="w-full sm:w-auto px-8 py-4 bg-zinc-700 text-white font-bold rounded-xl shadow-md hover:bg-zinc-800 focus:outline-none focus:ring-2 focus:ring-zinc-600 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95 hidden" aria-label="Copy all split parts">
                Copy All Parts
            </button>
            <button id="downloadTxtButton" class="w-full sm:w-auto px-8 py-4 bg-zinc-500 text-white font-bold rounded-xl shadow-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-400 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95 hidden" aria-label="Download all parts as a text file">
                Download All as .txt
            </button>
            <button id="downloadMdButton" class="w-full sm:w-auto px-8 py-4 bg-zinc-500 text-white font-bold rounded-xl shadow-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-400 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95 hidden" aria-label="Download all parts as a markdown file">
                Download All as .md
            </button>
            <button id="downloadJsonButton" class="w-full sm:w-auto px-8 py-4 bg-zinc-500 text-white font-bold rounded-xl shadow-md hover:bg-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-400 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95 hidden" aria-label="Download all parts as a JSON file">
                Download All as .json
            </button>
            <button id="saveSessionButton" class="w-full sm:w-auto px-8 py-4 bg-purple-600 text-white font-bold rounded-xl shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-400 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95" aria-label="Save current session to local storage">
                Save Current Session
            </button>
             <button id="generateShareLinkButton" class="w-full sm:w-auto px-8 py-4 bg-yellow-500 text-white font-bold rounded-xl shadow-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95" aria-label="Generate a shareable link for the current input">
                Share Link
            </button>
        </div>

        <div id="recentSessionsContainer" class="mt-8 mb-10 p-4 bg-zinc-100 rounded-xl border border-zinc-200 dark:bg-zinc-700 dark:border-zinc-600 hidden">
            <h3 class="text-xl font-bold text-zinc-800 mb-4 dark:text-zinc-100">Recent Sessions</h3>
            <div id="recentSessionsList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Recent sessions will be loaded here -->
            </div>
        </div>

        <div id="splitMapContainer" class="mt-8 mb-10 p-4 bg-zinc-100 rounded-xl border border-zinc-200 dark:bg-zinc-700 dark:border-zinc-600 hidden">
            <h3 class="text-xl font-bold text-zinc-800 mb-4 dark:text-zinc-100">Visual Split Map</h3>
            <svg id="splitMap" class="w-full" height="50" role="img" aria-label="Visual map of split text parts"></svg>
        </div>

        <!-- Collapsible Output Controls & TOC -->
        <div id="outputControls" class="mt-8 mb-4 flex flex-col sm:flex-row justify-between items-center hidden">
            <div id="outputToc" class="flex-grow flex flex-wrap gap-2 mb-4 sm:mb-0">
                <!-- TOC links will be here -->
            </div>
            <div class="flex space-x-2 ml-0 sm:ml-4">
                <button id="expandAllButton" class="px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600" aria-label="Expand all split parts">Expand All</button>
                <button id="collapseAllButton" class="px-4 py-2 bg-zinc-500 text-white text-sm rounded-lg hover:bg-zinc-600" aria-label="Collapse all split parts">Collapse All</button>
            </div>
        </div>

        <div id="outputContainer" class="mt-12 space-y-10">
            <!-- Split parts will be appended here -->
        </div>

        <!-- Donation/Sponsor Buttons Section -->
        <div class="mt-12 text-center border-t border-zinc-200 pt-10 dark:border-zinc-700">
            <h3 class="text-3xl font-bold text-zinc-800 mb-6 dark:text-zinc-100">Support This Project</h3>
            <p class="text-zinc-600 mb-8 max-w-xl mx-auto dark:text-zinc-400">If you find this Smart Text Splitter helpful, consider supporting its development. Your contribution helps keep this tool running and allows for future improvements!</p>
            <div class="flex flex-col sm:flex-row justify-center items-center space-y-4 sm:space-y-0 sm:space-x-6">
                <a href="YOUR_GITHUB_SPONSORS_PROFILE_URL" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-8 py-4 bg-zinc-800 text-white font-semibold rounded-xl shadow-md hover:bg-zinc-900 focus:outline-none focus:ring-2 focus:ring-zinc-700 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95" aria-label="Sponsor on GitHub">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM6 9a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path></svg>
                    Sponsor on GitHub
                </a>
                <a href="YOUR_KOFI_PROFILE_URL" target="_blank" rel="noopener noreferrer" class="inline-flex items-center px-8 py-4 bg-purple-600 text-white font-semibold rounded-xl shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95" aria-label="Buy me a coffee on Ko-fi">
                    <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 8.707l-6-6a1 1 0 00-1.414 0l-6 6a1 1 0 001.414 1.414L10 5.414V17a1 1 0 102 0V5.414l4.293 4.293a1 1 0 001.414-1.414z"></path></svg>
                    Buy me a coffee on Ko-fi
                </a>
            </div>
        </div>
        <!-- End Donation/Sponsor Buttons Section -->

        <!-- Social Share Buttons -->
        <div class="mt-12 text-center border-t border-zinc-200 pt-10 dark:border-zinc-700">
            <h3 class="text-2xl font-bold text-zinc-800 mb-4 dark:text-zinc-100">Share This Tool</h3>
            <div class="flex justify-center items-center space-x-4">
                <a href="https://twitter.com/intent/tweet?text=Check out this amazing Smart Text Splitter! %23textsplitter %23developer %23tool&url=https://www.yourdomain.app/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-700 dark:text-blue-300 dark:hover:text-blue-500" aria-label="Share on Twitter">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M22 4.01c-.72.32-1.5.53-2.32.61a4.87 4.87 0 002.13-2.22c-.8.47-1.7.8-2.65.98a4.92 4.92 0 00-8.38 4.47A13.9 13.9 0 013 5.43a4.92 4.92 0 001.52 6.57c-.63-.02-1.2-.2-1.7-.47v.06c0 1.64 1.17 3 2.7 3.32-.28.08-.57.12-.87.12-.21 0-.41-.02-.61-.06a4.92 4.92 0 004.59 3.42A9.85 9.85 0 013 18.06c-.66 0-1.3-.04-1.93-.11a13.92 13.92 0 007.54 2.21c9.05 0 14-7.48 14-14s-.04-2.1-.12-3.12z"></path></svg>
                </a>
                <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://www.yourdomain.app/&title=Smart Text Splitter - Divide Text Intelligently&summary=Effortlessly split any text or code into manageable sections for any platform.&source=" target="_blank" rel="noopener noreferrer" class="text-blue-700 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-600" aria-label="Share on LinkedIn">
                    <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M4.98 3.5c0 1.381-1.11 2.5-2.49 2.5s-2.49-1.119-2.49-2.5 1.11-2.5 2.49-2.5 2.49 1.119 2.49 2.5zM.35 24h4.9v-16h-4.9v16zM24 16.99c0 4.19-2.88 7.01-6.72 7.01-3.23 0-5.18-1.89-6.07-3.41v3.08h-4.9v-16h4.9v2.17c.64-1.17 1.83-2.17 4.1-2.17 4.7 0 7.28 3.06 7.28 8.01v8.93h-4.9v-8.49c0-1.81-.66-3.04-2.28-3.04-1.24 0-1.97.83-2.29 1.63-.12.29-.16.69-.16 1.1v7.8h-4.9v-10.7h4.9v2.17c.64-1.17 1.83-2.17 4.1-2.17 4.7 0 7.28 3.06 7.28 8.01v8.93z"></path></svg>
                </a>
                <!-- Add other social buttons as desired -->
            </div>
        </div>

        <div id="messageBox" class="fixed bottom-10 right-10 bg-green-600 text-white px-8 py-5 rounded-2xl shadow-xl hidden transition-all duration-300 ease-out opacity-0 translate-y-6 z-50" role="status" aria-live="polite">
            Text copied to clipboard!
        </div>

        <!-- Onboarding/Welcome Message -->
        <div id="welcomeMessage" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-600 text-white p-8 rounded-2xl shadow-2xl z-50 max-w-md text-center hidden transition-all duration-500 ease-out transform scale-95 opacity-0">
            <h3 class="text-2xl font-bold mb-4 font-outfit">Welcome to the God-Tier Splitter!</h3>
            <p class="mb-6">Start by pasting your text above to unleash its power. This tool intelligently divides content for any need.</p>
            <button id="dismissWelcome" class="px-6 py-3 bg-white text-blue-600 font-semibold rounded-xl hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-white">Got it!</button>
        </div>
    </div>

    <!-- Dark Mode Toggle Button -->
    <button id="darkModeToggle" class="fixed top-6 right-6 p-3 rounded-full bg-zinc-200 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-200 shadow-md focus:outline-none focus:ring-2 focus:ring-zinc-400 transition-colors duration-200 ease-in-out z-50" aria-label="Toggle dark mode">
        <span class="sr-only">Toggle dark mode</span>
        <svg id="moonIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
        <svg id="sunIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 4a1 1 0 011 1v1a1 1 0 11-2 0V7a1 1 0 011-1zm-4 4a1 1 0 011 1v1a1 1 0 11-2 0V11a1 1 0 011-1zm-4 4a1 1 0 011 1v1a1 1 0 11-2 0V15a1 1 0 011-1zm8-4a1 1 0 011 1v1a1 1 0 11-2 0V11a1 1 0 011-1zm-4 4a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zM2 10a1 1 0 011-1h1a1 1 0 110 2H3a1 1 0 01-1-1zm4 4a1 1 0 011 1v1a1 1 0 11-2 0V15a1 1 0 011-1zm4 4a1 1 0 011 1v1a1 1 0 11-2 0V19a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
    </button>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const inputText = document.getElementById('inputText');
            const numPartsInput = document.getElementById('numParts');
            const maxCharsInput = document.getElementById('maxChars');
            const customDelimiterInput = document.getElementById('customDelimiter');
            const splitMethodSelect = document.getElementById('splitMethod');
            const templateSelector = document.getElementById('templateSelector');
            const splitButton = document.getElementById('splitButton');
            const outputContainer = document.getElementById('outputContainer');
            const messageBox = document.getElementById('messageBox');
            const copyAllButton = document.getElementById('copyAllButton');
            const downloadTxtButton = document.getElementById('downloadTxtButton');
            const downloadMdButton = document.getElementById('downloadMdButton');
            const downloadJsonButton = document.getElementById('downloadJsonButton');
            const fileUpload = document.getElementById('fileUpload');
            const saveSessionButton = document.getElementById('saveSessionButton');
            const recentSessionsContainer = document.getElementById('recentSessionsContainer');
            const recentSessionsList = document.getElementById('recentSessionsList');
            const typeSuggestionBox = document.getElementById('typeSuggestion');
            const suggestionTextSpan = document.getElementById('suggestionText');
            const applySuggestionButton = document.getElementById('applySuggestion');
            const generateShareLinkButton = document.getElementById('generateShareLinkButton');

            // New UI elements for Output Controls & TOC
            const outputControls = document.getElementById('outputControls');
            const outputToc = document.getElementById('outputToc');
            const expandAllButton = document.getElementById('expandAllButton');
            const collapseAllButton = document.getElementById('collapseAllButton');

            // Onboarding elements
            const welcomeMessage = document.getElementById('welcomeMessage');
            const dismissWelcomeButton = document.getElementById('dismissWelcome');


            // Live Counters
            const charCountSpan = document.getElementById('charCount');
            const wordCountSpan = document.getElementById('wordCount');
            const estimatedPartInfoSpan = document.getElementById('estimatedPartInfo');

            // Input groups for dynamic visibility
            const partsInputGroup = document.getElementById('partsInputGroup');
            const maxCharsInputGroup = document.getElementById('maxCharsInputGroup');
            const customDelimiterInputGroup = document.getElementById('customDelimiterInputGroup');

            // Dark Mode Toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            const htmlElement = document.documentElement;
            const moonIcon = document.getElementById('moonIcon');
            const sunIcon = document.getElementById('sunIcon');

            let currentSplitParts = []; // To store the last split parts for export/sessions

            // --- PWA Registration (requires external manifest.json and sw.js for full functionality) ---
            // if ('serviceWorker' in navigator) {
            //     window.addEventListener('load', () => {
            //         navigator.serviceWorker.register('/sw.js')
            //             .then(registration => console.log('SW registered:', registration))
            //             .catch(error => console.log('SW registration failed:', error));
            //     });
            // }

            // --- Dark Mode Logic ---
            const setDarkMode = (isDark) => {
                if (isDark) {
                    htmlElement.classList.add('dark');
                    moonIcon.classList.add('hidden');
                    sunIcon.classList.remove('hidden');
                    localStorage.setItem('theme', 'dark');
                } else {
                    htmlElement.classList.remove('dark');
                    moonIcon.classList.remove('hidden');
                    sunIcon.classList.add('hidden');
                    localStorage.setItem('theme', 'light');
                }
            };

            // Check for saved theme preference or system preference
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                setDarkMode(savedTheme === 'dark');
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                setDarkMode(true);
            } else {
                setDarkMode(false); // Default to light mode
            }

            darkModeToggle.addEventListener('click', () => {
                setDarkMode(!htmlElement.classList.contains('dark'));
            });

            // --- Message Box Function ---
            function showMessage(message, type = 'success') {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-green-600', 'bg-red-600', 'bg-blue-600', 'bg-yellow-500', 'opacity-0', 'translate-y-6'); // Use yellow-500 for warning
                messageBox.classList.add('flex', 'items-center', 'justify-center');
                if (type === 'success') {
                    messageBox.classList.add('bg-green-600');
                } else if (type === 'error') {
                    messageBox.classList.add('bg-red-600');
                } else if (type === 'info') {
                    messageBox.classList.add('bg-blue-600');
                } else if (type === 'warning') { // New type for warnings
                    messageBox.classList.add('bg-yellow-500');
                }

                setTimeout(() => {
                    messageBox.classList.add('opacity-100', 'translate-y-0');
                }, 10);

                setTimeout(() => {
                    messageBox.classList.remove('opacity-100', 'translate-y-0');
                    messageBox.classList.add('opacity-0', 'translate-y-6');
                    setTimeout(() => {
                        messageBox.classList.add('hidden');
                        messageBox.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600', 'bg-yellow-500'); // Clean up colors
                    }, 300);
                }, 2500);
            }

            // --- Copy to Clipboard Function ---
            function copyToClipboard(text) {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.setAttribute('readonly', '');
                textarea.style.position = 'absolute';
                textarea.style.left = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    showMessage('Text copied to clipboard!', 'success');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    showMessage('Failed to copy text.', 'error');
                }
                document.body.removeChild(textarea);
            }

            // --- File Upload Logic ---
            fileUpload.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        inputText.value = e.target.result;
                        updateLivePreviews();
                        detectAndSuggestTextType(); // Detect type on file upload
                        saveState(); // Save state after file upload
                        showMessage(`File "${file.name}" loaded!`, 'success');
                    };
                    reader.onerror = () => {
                        showMessage('Failed to read file.', 'error');
                    };
                    reader.readAsText(file);
                }
            });

            // --- Smart Splitting Helper Functions ---

            function splitTextIntoNParts(text, numParts) {
                // Prioritize natural breaks: paragraphs, then sentences, then words
                const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
                const sentences = splitBySentences(text);
                const words = text.split(/\s+/).filter(word => word.length > 0);

                if (paragraphs.length >= numParts * 0.8 && paragraphs.length <= numParts * 1.5) {
                    return distributeParts(paragraphs, numParts);
                }
                if (sentences.length >= numParts * 0.8 && sentences.length <= numParts * 2) {
                    return distributeParts(sentences, numParts);
                }
                return distributeParts(words, numParts, ' ');
            }

            function distributeParts(items, numParts, joinChar = '\n\n') {
                const totalItems = items.length;
                if (totalItems === 0 || numParts === 0) return [];
                const itemsPerPart = Math.ceil(totalItems / numParts);
                const resultParts = [];
                for (let i = 0; i < numParts; i++) {
                    const startItemIndex = i * itemsPerPart;
                    const endItemIndex = Math.min(startItemIndex + itemsPerPart, totalItems);
                    const part = items.slice(startItemIndex, endItemIndex).join(joinChar);
                    if (part.trim().length > 0) {
                        resultParts.push(part.trim());
                    }
                }
                return resultParts;
            }

            function splitTextByMaxChars(text, maxChars) {
                const resultParts = [];
                let currentPos = 0;

                while (currentPos < text.length) {
                    let endPos = Math.min(currentPos + maxChars, text.length);

                    if (endPos < text.length) {
                        let tempEnd = endPos;
                        // Search backward for nearest space, newline, or common punctuation
                        while (tempEnd > currentPos && !/\s|[.,;!?'"(){}[\]]/.test(text[tempEnd - 1])) {
                            tempEnd--;
                        }
                        // If a good break was found and it's not too far back (e.g., more than 10% deviation from maxChars)
                        if (tempEnd > currentPos && (endPos - tempEnd < maxChars * 0.1 || tempEnd === currentPos)) {
                             endPos = tempEnd;
                        } else if (tempEnd === currentPos) { // If no break at all, force a break
                            endPos = Math.min(currentPos + maxChars, text.length);
                        } else { // If going too far back, just take the maxChars
                            endPos = Math.min(currentPos + maxChars, text.length);
                        }
                    }

                    const part = text.substring(currentPos, endPos).trim();
                    if (part) {
                        resultParts.push(part);
                    }
                    currentPos = endPos;
                }
                return resultParts;
            }

            function splitBySentences(text) {
                if (typeof Intl !== 'undefined' && Intl.Segmenter) {
                    const segmenter = new Intl.Segmenter(navigator.language || 'en', { granularity: 'sentence' });
                    return Array.from(segmenter.segment(text)).map(s => s.segment.trim()).filter(s => s.length > 0);
                } else {
                    // Fallback to basic regex-based sentence splitting (less accurate)
                    return text.split(/(?<=[.!?])\s+(?=[A-Z0-9]|$)/g).map(s => s.trim()).filter(s => s.length > 0);
                }
            }

            function splitByParagraphs(text) {
                return text.split(/\n\s*\n/g).map(p => p.trim()).filter(p => p.length > 0);
            }

            // --- Advanced Core Upgrades ---
            // 7. Smart Content-Aware Splitting (via Regex for inline solution)
            function splitByMarkdownHeaders(text) {
                const parts = [];
                // This regex attempts to capture a header and all content until the next header or end of string.
                // It's a heuristic and might not catch all markdown nuances.
                const regex = /(^#{1,6}\s.*(?:\n(?!#).*)*?(?=\n#{1,6}\s|$))|(^.*?(?=\n#{1,6}\s|$))/gm;

                let lastIndex = 0;
                let match;

                while ((match = regex.exec(text)) !== null) {
                    const matchedContent = match[0].trim();
                    if (matchedContent.length > 0) {
                        parts.push(matchedContent);
                    }
                    lastIndex = regex.lastIndex;
                }

                if (parts.length === 0 && text.trim().length > 0) {
                    // If no headers found, fall back to paragraphs or single chunk
                    return splitByParagraphs(text);
                }
                return parts;
            }

            function splitByCodeFunctions(text) {
                const parts = [];
                // Simple regex for common JS/TS/Java/C# functions/classes/methods.
                // This is a heuristic and will not be foolproof for all languages or complex structures.
                const functionRegex = /(?:(?:export|public|private|protected|static|async)\s+)?(?:function\s+\w+|class\s+\w+|const\s+\w+\s*=\s*(?:function)?\s*\(.*?\)\s*=>|var\s+\w+\s*=\s*(?:function)?\s*\(|new\s+Class\s*\(|(?:\w+\.)?\w+\s*=\s*function\s*\(|constructor\s*\(|get\s+\w+|set\s+\w+)\s*\{[\s\S]*?\n\s*\}/g;

                let lastIndex = 0;
                let match;

                while ((match = functionRegex.exec(text)) !== null) {
                    // Add any content before this match as a separate part (e.g., imports, global variables)
                    if (match.index > lastIndex) {
                        const preamble = text.substring(lastIndex, match.index).trim();
                        if (preamble.length > 0) {
                            parts.push(preamble);
                        }
                    }
                    parts.push(match[0].trim());
                    lastIndex = functionRegex.lastIndex;
                }

                // Add any remaining content after the last match
                if (lastIndex < text.length) {
                    const remaining = text.substring(lastIndex).trim();
                    if (remaining.length > 0) {
                        parts.push(remaining);
                    }
                }

                if (parts.length === 0 && text.trim().length > 0) {
                    // If no functions/classes found, fall back to blank lines or single chunk
                    return text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
                }
                return parts;
            }


            // --- 9. Text Type Detection ---
            function detectTextType(text) {
                text = text.trim();
                if (text.length === 0) return 'plainText';

                // Markdown detection heuristics
                const isMarkdown = (
                    /^#{1,6}\s.+/m.test(text) || // Has headers
                    /^\s*[-*+]\s.+/m.test(text) || // Has list items
                    /^>\s.+/m.test(text) || // Has blockquotes
                    /^```(?:\w+)?\n[\s\S]*?\n```/m.test(text) // Has code blocks
                );

                // Code detection heuristics (simple, can be expanded)
                const isCode = (
                    /^(?:function|class|const|let|var)\s+\w+/.test(text) || // JS/TS function/class declaration
                    /public\s+(?:class|static|void|int|string)/.test(text) || // Java/C# class/method
                    /def\s+\w+\s*\(/.test(text) || // Python function
                    /^\s*import\s+\w+/.test(text) || // Imports
                    /\/\/|#|\/\*|\*\//.test(text) || // Comments
                    /(async\s+)?(function\*?\s*\w*?\(|class\s+\w+|const\s+\w+\s*=\s*(?:\(|async\s+)?function\()/g.test(text) // More comprehensive JS/TS detection
                );

                if (isCode && !isMarkdown) return 'code';
                if (isMarkdown && !isCode) return 'markdown';
                if (isCode && isMarkdown) return 'mixed'; // Ambiguous or both
                return 'plainText';
            }

            function detectAndSuggestTextType() {
                const text = inputText.value;
                const detectedType = detectTextType(text);

                typeSuggestionBox.classList.add('hidden');
                suggestionTextSpan.textContent = '';
                applySuggestionButton.onclick = null;

                let suggestedMethod = '';
                let suggestionMessage = '';

                if (detectedType === 'code') {
                    suggestedMethod = 'codeFunctions';
                    suggestionMessage = 'It looks like you\'ve pasted code. How about splitting by Functions/Classes?';
                } else if (detectedType === 'markdown') {
                    suggestedMethod = 'markdownHeaders';
                    suggestionMessage = 'This appears to be Markdown. Splitting by Headers might be best!';
                } else if (detectedType === 'mixed') {
                    suggestedMethod = 'paragraphs'; // Default to a safe bet for mixed
                    suggestionMessage = 'Looks like a mix of code and text. Splitting by Paragraphs could be a good start.';
                }

                if (suggestedMethod && splitMethodSelect.value !== suggestedMethod) {
                    typeSuggestionBox.classList.remove('hidden');
                    suggestionTextSpan.textContent = suggestionMessage;
                    applySuggestionButton.onclick = () => {
                        splitMethodSelect.value = suggestedMethod;
                        toggleSplitMethodInputs();
                        updateLivePreviews();
                        typeSuggestionBox.classList.add('hidden');
                        showMessage(`Applied suggested method: ${suggestedMethod}`, 'info');
                    };
                }
            }

            // Call detection on input and paste
            inputText.addEventListener('input', () => {
                updateLivePreviews();
                detectAndSuggestTextType(); // Re-detect on every input
                saveState(); // Save current text and settings
            });
            inputText.addEventListener('paste', () => {
                // A small delay to ensure value is updated after paste
                setTimeout(detectAndSuggestTextType, 100);
            });

            // --- Live Counters & Preview ---
            function updateLivePreviews() {
                const text = inputText.value;
                const totalChars = text.length;
                const totalWords = text.split(/\s+/).filter(word => word.length > 0).length;

                charCountSpan.textContent = `Characters: ${totalChars}`;
                wordCountSpan.textContent = `Words: ${totalWords}`;

                const splitMethod = splitMethodSelect.value;
                let estimatedParts = 0;
                let estimatedCharsPerPart = 0;

                if (totalChars === 0) {
                    estimatedPartInfoSpan.textContent = '';
                    return;
                }

                if (splitMethod === 'numParts') {
                    const numParts = parseInt(numPartsInput.value, 10);
                    if (numParts > 0) {
                        estimatedCharsPerPart = Math.ceil(totalChars / numParts);
                        estimatedParts = numParts;
                        estimatedPartInfoSpan.textContent = ` | Estimated: ${estimatedParts} parts, ~${estimatedCharsPerPart} chars/part`;
                    } else {
                        estimatedPartInfoSpan.textContent = '';
                    }
                } else if (splitMethod === 'maxChars') {
                    const maxChars = parseInt(maxCharsInput.value, 10);
                    if (maxChars > 0) {
                        estimatedParts = Math.ceil(totalChars / maxChars);
                        estimatedCharsPerPart = maxChars;
                        estimatedPartInfoSpan.textContent = ` | Estimated: ${estimatedParts} parts, max ${estimatedCharsPerPart} chars/part`;
                    } else {
                        estimatedPartInfoSpan.textContent = '';
                    }
                } else {
                    estimatedPartInfoSpan.textContent = ` | Actual parts calculated on split`;
                }
            }


            // --- Dynamic Input Visibility based on Split Method ---
            function toggleSplitMethodInputs() {
                partsInputGroup.classList.add('hidden');
                maxCharsInputGroup.classList.add('hidden');
                customDelimiterInputGroup.classList.add('hidden');

                switch (splitMethodSelect.value) {
                    case 'numParts':
                        partsInputGroup.classList.remove('hidden');
                        break;
                    case 'maxChars':
                        maxCharsInputGroup.classList.remove('hidden');
                        break;
                    case 'customDelimiter':
                        customDelimiterInputGroup.classList.remove('hidden');
                        break;
                    // Sentences, Paragraphs, Markdown Headers, Code Functions don't need extra input fields
                }
                updateLivePreviews();
            }
            splitMethodSelect.addEventListener('change', toggleSplitMethodInputs);


            // --- Templates Logic ---
            const templates = {
                'twitter-thread': { splitMethod: 'maxChars', maxChars: 280, description: 'Optimized for Twitter/X threads (280 chars).' },
                'reddit-post': { splitMethod: 'paragraphs', description: 'Splits by paragraphs for Reddit posts.' },
                'discord-chunk': { splitMethod: 'maxChars', maxChars: 1900, description: 'Splits for Discord messages (max ~2000 chars).' },
                'code-blocks': { splitMethod: 'customDelimiter', customDelimiter: '\n\n', description: 'Splits by blank lines, useful for code functions.' },
                'none': {} // Placeholder for "Select a template"
            };

            templateSelector.addEventListener('change', (event) => {
                const selectedTemplate = templates[event.target.value];
                if (selectedTemplate) {
                    splitMethodSelect.value = selectedTemplate.splitMethod || 'numParts';
                    numPartsInput.value = selectedTemplate.numParts || '2';
                    maxCharsInput.value = selectedTemplate.maxChars || '1000';
                    customDelimiterInput.value = selectedTemplate.customDelimiter || '';

                    toggleSplitMethodInputs();
                    updateLivePreviews();
                    saveState();

                    if (selectedTemplate.description) {
                        showMessage(`Template loaded: ${selectedTemplate.description}`, 'info');
                    } else if (event.target.value === 'none') {
                        showMessage('Template cleared.', 'info');
                    }
                }
            });

            // --- Main Split Logic ---
            splitButton.addEventListener('click', () => {
                const text = inputText.value;
                const splitMethod = splitMethodSelect.value;
                let parts = [];

                outputContainer.innerHTML = ''; // Clear previous output
                outputControls.classList.add('hidden'); // Hide output controls until content is there
                outputToc.innerHTML = ''; // Clear TOC
                copyAllButton.classList.add('hidden');
                downloadTxtButton.classList.add('hidden');
                downloadMdButton.classList.add('hidden');
                downloadJsonButton.classList.add('hidden');
                document.getElementById('splitMapContainer').classList.add('hidden');


                if (!text.trim()) {
                    showMessage('Oops! Please enter some text to split.', 'error');
                    return;
                }

                try {
                    switch (splitMethod) {
                        case 'numParts':
                            const numParts = parseInt(numPartsInput.value, 10);
                            if (isNaN(numParts) || numParts < 1) { showMessage('Valid number of parts needed.', 'error'); return; }
                            parts = splitTextIntoNParts(text, numParts);
                            break;
                        case 'maxChars':
                            const maxChars = parseInt(maxCharsInput.value, 10);
                            if (isNaN(maxChars) || maxChars < 10) { showMessage('Valid max characters needed.', 'error'); return; }
                            parts = splitTextByMaxChars(text, maxChars);
                            break;
                        case 'sentences':
                            parts = splitBySentences(text);
                            break;
                        case 'paragraphs':
                            parts = splitByParagraphs(text);
                            break;
                        case 'markdownHeaders':
                            parts = splitByMarkdownHeaders(text);
                            break;
                        case 'codeFunctions':
                            parts = splitByCodeFunctions(text);
                            break;
                        case 'customDelimiter':
                            const delimiter = customDelimiterInput.value;
                            if (!delimiter) { showMessage('Custom delimiter needed.', 'error'); return; }
                            const regexDelimiter = new RegExp(delimiter.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                            parts = text.split(regexDelimiter).map(p => p.trim()).filter(p => p.length > 0);
                            break;
                        default:
                            showMessage('Invalid split method selected.', 'error');
                            return;
                    }

                    if (parts.length === 0) {
                         showMessage('No parts generated. Try adjusting your input or splitting method.', 'error');
                         return;
                    }

                    currentSplitParts = parts; // Store for export/sessions

                    parts.forEach((partText, i) => {
                        const partDiv = document.createElement('div');
                        partDiv.id = `part-${i + 1}`; // Unique ID for navigation
                        partDiv.className = 'bg-white p-8 rounded-2xl shadow-lg border border-zinc-200 transform transition-transform duration-200 ease-out hover:scale-[1.01] dark:bg-zinc-800 dark:border-zinc-700';

                        const partHeader = document.createElement('h3');
                        partHeader.className = 'text-2xl font-bold text-zinc-800 mb-5 flex justify-between items-center dark:text-zinc-100';

                        const headerText = document.createElement('span');
                        headerText.className = 'flex items-center';
                        const dragHandle = document.createElement('span');
                        dragHandle.className = 'drag-handle cursor-grab text-zinc-400 hover:text-zinc-600 mr-3 dark:text-zinc-500 dark:hover:text-zinc-400';
                        dragHandle.innerHTML = '<svg class="w-5 h-5 inline-block" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 14V4h10v12H5zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"></path></svg>';
                        headerText.appendChild(dragHandle);
                        headerText.innerHTML += `Part ${i + 1} <span class="text-sm font-normal text-zinc-500 ml-2 dark:text-zinc-400">(~${partText.length} characters, ${partText.split(/\s+/).filter(w => w.length > 0).length} words)</span>`;
                        partHeader.appendChild(headerText);

                        const copyBtn = document.createElement('button');
                        copyBtn.className = 'px-6 py-3 bg-blue-500 text-white text-base font-semibold rounded-xl shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95 copy-part-btn';
                        copyBtn.textContent = 'Copy Part';
                        copyBtn.setAttribute('aria-label', `Copy part ${i + 1}`);
                        copyBtn.addEventListener('click', () => {
                            copyToClipboard(partText);
                        });
                        partHeader.appendChild(copyBtn);
                        partDiv.appendChild(partHeader);

                        const preTag = document.createElement('pre');
                        preTag.className = 'whitespace-pre-wrap break-words text-sm text-zinc-900 bg-zinc-50 p-5 rounded-xl border border-zinc-200 overflow-hidden max-h-40 font-inter leading-relaxed dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-200';
                        preTag.textContent = partText;
                        partDiv.appendChild(preTag);

                        // Collapsible toggle
                        if (partText.length > 300) {
                            const toggleButton = document.createElement('button');
                            toggleButton.className = 'text-blue-600 hover:text-blue-700 mt-2 text-sm dark:text-blue-400 dark:hover:text-blue-500 toggle-content-btn';
                            toggleButton.textContent = 'Show Full Part';
                            toggleButton.setAttribute('aria-expanded', 'false');
                            toggleButton.setAttribute('aria-controls', `part-${i + 1}-content`);
                            preTag.id = `part-${i + 1}-content`; // Set ID for aria-controls
                            toggleButton.addEventListener('click', (e) => {
                                const targetPre = e.target.previousElementSibling;
                                const isExpanded = targetPre.classList.contains('max-h-none');
                                if (!isExpanded) {
                                    targetPre.classList.remove('max-h-40', 'overflow-hidden');
                                    targetPre.classList.add('max-h-none');
                                    e.target.textContent = 'Show Less';
                                    e.target.setAttribute('aria-expanded', 'true');
                                } else {
                                    targetPre.classList.remove('max-h-none');
                                    targetPre.classList.add('max-h-40', 'overflow-hidden');
                                    e.target.textContent = 'Show Full Part';
                                    e.target.setAttribute('aria-expanded', 'false');
                                }
                            });
                            partDiv.appendChild(toggleButton);
                        }

                        outputContainer.appendChild(partDiv);
                    });

                    if (parts.length > 0) {
                        copyAllButton.classList.remove('hidden');
                        downloadTxtButton.classList.remove('hidden');
                        downloadMdButton.classList.remove('hidden');
                        downloadJsonButton.classList.remove('hidden');
                        outputControls.classList.remove('hidden'); // Show output controls
                        renderVisualSplitMap(parts);
                        renderTableOfContents(parts); // Generate TOC

                        Sortable.create(outputContainer, {
                            animation: 150,
                            ghostClass: 'sortable-ghost',
                            handle: '.drag-handle',
                            onEnd: function (evt) {
                                // Update currentSplitParts order after reorder
                                const movedItem = currentSplitParts.splice(evt.oldIndex, 1)[0];
                                currentSplitParts.splice(evt.newIndex, 0, movedItem);
                                // Re-render TOC and map to reflect new order and IDs
                                renderTableOfContents(currentSplitParts);
                                renderVisualSplitMap(currentSplitParts);
                                // Re-assign IDs to parts in the DOM to match the new order for scrolling
                                Array.from(outputContainer.children).forEach((child, idx) => {
                                    child.id = `part-${idx + 1}`;
                                    // Also update aria-controls if present
                                    const toggleBtn = child.querySelector('.toggle-content-btn');
                                    if (toggleBtn) {
                                        toggleBtn.setAttribute('aria-controls', `part-${idx + 1}-content`);
                                        child.querySelector('pre').id = `part-${idx + 1}-content`;
                                    }
                                });
                            },
                        });
                    }

                } catch (e) {
                    console.error("Splitting error:", e);
                    showMessage('An error occurred during splitting. Please check your input.', 'error');
                }
                saveState(); // Save current state (text, method, settings)
            });

            // --- Collapsible Output & Part Navigation ---
            expandAllButton.addEventListener('click', () => {
                outputContainer.querySelectorAll('.toggle-content-btn').forEach(button => {
                    const preTag = button.previousElementSibling;
                    if (preTag.classList.contains('max-h-40')) {
                        preTag.classList.remove('max-h-40', 'overflow-hidden');
                        preTag.classList.add('max-h-none');
                        button.textContent = 'Show Less';
                        button.setAttribute('aria-expanded', 'true');
                    }
                });
            });

            collapseAllButton.addEventListener('click', () => {
                outputContainer.querySelectorAll('.toggle-content-btn').forEach(button => {
                    const preTag = button.previousElementSibling;
                    if (preTag.classList.contains('max-h-none')) {
                        preTag.classList.remove('max-h-none');
                        preTag.classList.add('max-h-40', 'overflow-hidden');
                        button.textContent = 'Show Full Part';
                        button.setAttribute('aria-expanded', 'false');
                    }
                });
            });

            function renderTableOfContents(parts) {
                outputToc.innerHTML = '';
                parts.forEach((_, i) => {
                    const tocLink = document.createElement('a');
                    tocLink.href = `#part-${i + 1}`;
                    tocLink.textContent = `Part ${i + 1}`;
                    tocLink.className = 'px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium hover:bg-blue-200 dark:bg-blue-800 dark:text-blue-100 dark:hover:bg-blue-700 transition-colors duration-150';
                    tocLink.setAttribute('aria-label', `Jump to part ${i + 1}`);
                    tocLink.addEventListener('click', (e) => {
                        e.preventDefault();
                        document.querySelector(tocLink.hash).scrollIntoView({ behavior: 'smooth' });
                    });
                    outputToc.appendChild(tocLink);
                });
            }


            // --- 8. Save/Export Sessions ---

            // Save current session (text input, method, parts)
            saveSessionButton.addEventListener('click', () => {
                const text = inputText.value;
                const splitMethod = splitMethodSelect.value;
                const currentPartsText = currentSplitParts; // Use the stored parts

                if (!text.trim() || currentPartsText.length === 0) {
                    showMessage('Nothing to save. Please split some text first.', 'error');
                    return;
                }

                const sessions = JSON.parse(localStorage.getItem('savedSplitSessions') || '[]');
                const newSession = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString(),
                    inputText: text.substring(0, 200) + (text.length > 200 ? '...' : ''), // Truncate input for display
                    splitMethod: splitMethod,
                    numPartsSetting: numPartsInput.value, // Save current settings
                    maxCharsSetting: maxCharsInput.value,
                    customDelimiterSetting: customDelimiterInput.value,
                    parts: currentPartsText,
                    numOutputParts: currentPartsText.length,
                };
                sessions.unshift(newSession); // Add to the beginning
                localStorage.setItem('savedSplitSessions', JSON.stringify(sessions));
                showMessage('Session saved successfully!', 'success');
                renderRecentSessions();
            });

            // Load recent sessions
            function renderRecentSessions() {
                const sessions = JSON.parse(localStorage.getItem('savedSplitSessions') || '[]');
                recentSessionsList.innerHTML = '';
                if (sessions.length > 0) {
                    recentSessionsContainer.classList.remove('hidden');
                    sessions.forEach(session => {
                        const sessionCard = document.createElement('div');
                        sessionCard.className = 'bg-white p-4 rounded-xl shadow-md border border-zinc-200 dark:bg-zinc-800 dark:border-zinc-700';
                        sessionCard.innerHTML = `
                            <p class="font-semibold text-zinc-800 dark:text-zinc-100 mb-1">Method: ${session.splitMethod} (${session.numOutputParts} parts)</p>
                            <p class="text-sm text-zinc-600 dark:text-zinc-400 mb-2">${session.timestamp}</p>
                            <p class="text-sm text-zinc-700 dark:text-zinc-300 truncate mb-3">Input: ${session.inputText}</p>
                            <button data-session-id="${session.id}" class="load-session-btn px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600 mr-2" aria-label="Load session from ${session.timestamp}">Load</button>
                            <button data-session-id="${session.id}" class="delete-session-btn px-4 py-2 bg-red-500 text-white text-sm rounded-lg hover:bg-red-600" aria-label="Delete session from ${session.timestamp}">Delete</button>
                        `;
                        recentSessionsList.appendChild(sessionCard);
                    });

                    document.querySelectorAll('.load-session-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const sessionId = parseInt(e.target.dataset.sessionId);
                            const sessionToLoad = sessions.find(s => s.id === sessionId);
                            if (sessionToLoad) {
                                inputText.value = sessionToLoad.parts.join('\n\n--- PART BREAK ---\n\n'); // Reconstruct for input area
                                splitMethodSelect.value = sessionToLoad.splitMethod;
                                numPartsInput.value = sessionToLoad.numPartsSetting || '2';
                                maxCharsInput.value = sessionToLoad.maxCharsSetting || '1000';
                                customDelimiterInput.value = sessionToLoad.customDelimiterSetting || '';

                                toggleSplitMethodInputs();
                                updateLivePreviews();
                                // Directly render the parts, no need to re-split as they are saved
                                outputContainer.innerHTML = '';
                                currentSplitParts = sessionToLoad.parts; // Set currentSplitParts
                                sessionToLoad.parts.forEach((partText, i) => {
                                    const partDiv = document.createElement('div');
                                    partDiv.id = `part-${i + 1}`;
                                    partDiv.className = 'bg-white p-8 rounded-2xl shadow-lg border border-zinc-200 transform transition-transform duration-200 ease-out hover:scale-[1.01] dark:bg-zinc-800 dark:border-zinc-700';
                                    partDiv.innerHTML = `
                                        <h3 class="text-2xl font-bold text-zinc-800 mb-5 flex justify-between items-center dark:text-zinc-100">
                                            <span class="flex items-center">
                                                <span class="drag-handle cursor-grab text-zinc-400 hover:text-zinc-600 mr-3 dark:text-zinc-500 dark:hover:text-zinc-400">
                                                    <svg class="w-5 h-5 inline-block" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M5 2a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V4a2 2 0 00-2-2H5zm0 14V4h10v12H5zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z"></path></svg>
                                                </span>
                                                Part ${i + 1} <span class="text-sm font-normal text-zinc-500 ml-2 dark:text-zinc-400">(~${partText.length} characters, ${partText.split(/\s+/).filter(w => w.length > 0).length} words)</span>
                                            </span>
                                            <button class="px-6 py-3 bg-blue-500 text-white text-base font-semibold rounded-xl shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-offset-2 transition duration-200 ease-in-out transform hover:-translate-y-0.5 active:scale-95 copy-part-btn" aria-label="Copy part ${i + 1}">Copy Part</button>
                                        </h3>
                                        <pre class="whitespace-pre-wrap break-words text-sm text-zinc-900 bg-zinc-50 p-5 rounded-xl border border-zinc-200 overflow-hidden max-h-40 font-inter leading-relaxed dark:bg-zinc-700 dark:border-zinc-600 dark:text-zinc-200" id="part-${i + 1}-content">${partText}</pre>
                                        ${partText.length > 300 ? `<button class="text-blue-600 hover:text-blue-700 mt-2 text-sm dark:text-blue-400 dark:hover:text-blue-500 toggle-content-btn" aria-expanded="false" aria-controls="part-${i + 1}-content">Show Full Part</button>` : ''}
                                    `;
                                    outputContainer.appendChild(partDiv);
                                });
                                // Re-attach copy and toggle listeners
                                outputContainer.querySelectorAll('.copy-part-btn').forEach((btn, idx) => {
                                    btn.addEventListener('click', () => copyToClipboard(currentSplitParts[idx]));
                                });
                                outputContainer.querySelectorAll('.toggle-content-btn').forEach(btn => {
                                    btn.addEventListener('click', (e) => {
                                        const targetPre = e.target.previousElementSibling;
                                        const isExpanded = targetPre.classList.contains('max-h-none');
                                        if (!isExpanded) {
                                            targetPre.classList.remove('max-h-40', 'overflow-hidden');
                                            targetPre.classList.add('max-h-none');
                                            e.target.textContent = 'Show Less';
                                            e.target.setAttribute('aria-expanded', 'true');
                                        } else {
                                            targetPre.classList.remove('max-h-none');
                                            targetPre.classList.add('max-h-40', 'overflow-hidden');
                                            e.target.textContent = 'Show Full Part';
                                            e.target.setAttribute('aria-expanded', 'false');
                                        }
                                    });
                                });

                                // Enable export buttons and sortable
                                copyAllButton.classList.remove('hidden');
                                downloadTxtButton.classList.remove('hidden');
                                downloadMdButton.classList.remove('hidden');
                                downloadJsonButton.classList.remove('hidden');
                                outputControls.classList.remove('hidden'); // Show output controls
                                renderVisualSplitMap(currentSplitParts);
                                renderTableOfContents(currentSplitParts); // Render TOC for loaded session

                                Sortable.create(outputContainer, {
                                    animation: 150,
                                    ghostClass: 'sortable-ghost',
                                    handle: '.drag-handle',
                                    onEnd: function (evt) {
                                        const movedItem = currentSplitParts.splice(evt.oldIndex, 1)[0];
                                        currentSplitParts.splice(evt.newIndex, 0, movedItem);
                                        renderVisualSplitMap(currentSplitParts);
                                        renderTableOfContents(currentSplitParts);
                                        Array.from(outputContainer.children).forEach((child, idx) => {
                                            child.id = `part-${idx + 1}`;
                                            const toggleBtn = child.querySelector('.toggle-content-btn');
                                            if (toggleBtn) {
                                                toggleBtn.setAttribute('aria-controls', `part-${idx + 1}-content`);
                                                child.querySelector('pre').id = `part-${idx + 1}-content`;
                                            }
                                        });
                                    },
                                });
                                showMessage('Session loaded!', 'success');
                            }
                        });
                    });

                    document.querySelectorAll('.delete-session-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const sessionIdToDelete = parseInt(e.target.dataset.sessionId);
                            let currentSessions = JSON.parse(localStorage.getItem('savedSplitSessions') || '[]');
                            currentSessions = currentSessions.filter(s => s.id !== sessionIdToDelete);
                            localStorage.setItem('savedSplitSessions', JSON.stringify(currentSessions));
                            showMessage('Session deleted!', 'info');
                            renderRecentSessions();
                        });
                    });

                } else {
                    recentSessionsContainer.classList.add('hidden');
                }
            }

            // Export as .txt
            downloadTxtButton.addEventListener('click', () => {
                const allParts = Array.from(outputContainer.querySelectorAll('pre')).map(pre => pre.textContent.trim());
                const combinedText = allParts.join('\n\n--- PART BREAK ---\n\n');
                const filename = `smart-split-${new Date().toISOString().slice(0,10)}.txt`;
                downloadFile(filename, combinedText, 'text/plain');
            });

            // Export as .md
            downloadMdButton.addEventListener('click', () => {
                const allParts = Array.from(outputContainer.querySelectorAll('pre')).map(pre => pre.textContent.trim());
                const combinedMarkdown = allParts.map((part, index) => {
                    const header = `## Part ${index + 1}\n\n`;
                    return header + part;
                }).join('\n\n---\n\n'); // Use markdown separator
                const filename = `smart-split-${new Date().toISOString().slice(0,10)}.md`;
                downloadFile(filename, combinedMarkdown, 'text/markdown');
            });

            // Export as .json
            downloadJsonButton.addEventListener('click', () => {
                const allParts = Array.from(outputContainer.querySelectorAll('pre')).map(pre => pre.textContent.trim());
                const exportData = {
                    timestamp: new Date().toISOString(),
                    splitMethod: splitMethodSelect.value,
                    originalInputLength: inputText.value.length,
                    parts: allParts.map((content, index) => ({
                        partNumber: index + 1,
                        length: content.length,
                        content: content
                    }))
                };
                const filename = `smart-split-${new Date().toISOString().slice(0,10)}.json`;
                downloadFile(filename, JSON.stringify(exportData, null, 2), 'application/json');
            });

            function downloadFile(filename, content, type) {
                const element = document.createElement('a');
                element.setAttribute('href', `data:${type};charset=utf-8,` + encodeURIComponent(content));
                element.setAttribute('download', filename);
                element.style.display = 'none';
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
                showMessage(`File downloaded as .${filename.split('.').pop()}!`, 'success');
            }


            // --- Copy All Button ---
            copyAllButton.addEventListener('click', () => {
                const allParts = Array.from(outputContainer.querySelectorAll('pre')).map(pre => pre.textContent.trim());
                copyToClipboard(allParts.join('\n\n--- PART BREAK ---\n\n'));
            });


            // --- Shareable Links ---
            generateShareLinkButton.addEventListener('click', () => {
                const text = inputText.value;
                const method = splitMethodSelect.value;
                const numParts = numPartsInput.value;
                const maxChars = maxCharsInput.value;
                const customDelimiter = customDelimiterInput.value;

                if (text.length > 5000) { // Arbitrary limit for URL safety
                    showMessage('Text is too long to share via URL. Please use file export.', 'warning');
                    return;
                }

                const params = new URLSearchParams();
                params.set('text', encodeURIComponent(text));
                params.set('method', method);
                if (method === 'numParts') {
                    params.set('numParts', numParts);
                } else if (method === 'maxChars') {
                    params.set('maxChars', maxChars);
                } else if (method === 'customDelimiter') {
                    params.set('delimiter', encodeURIComponent(customDelimiter));
                }

                const shareUrl = window.location.origin + window.location.pathname + '?' + params.toString();
                copyToClipboard(shareUrl);
                showMessage('Shareable link copied! (May be truncated for very long texts)', 'info');
            });


            // --- Visual Split Map ---
            function renderVisualSplitMap(parts) {
                const splitMapContainer = document.getElementById('splitMapContainer');
                const splitMapSvg = document.getElementById('splitMap');
                if (parts.length === 0) {
                    splitMapContainer.classList.add('hidden');
                    return;
                }
                splitMapContainer.classList.remove('hidden');
                splitMapSvg.innerHTML = ''; // Clear previous map

                const totalLength = parts.reduce((sum, part) => sum + part.length, 0);
                let currentX = 0;

                parts.forEach((part, index) => {
                    const width = (part.length / totalLength) * 100; // Width as percentage
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', `${currentX}%`);
                    rect.setAttribute('y', '0');
                    rect.setAttribute('width', `${width}%`);
                    rect.setAttribute('height', '50');
                    rect.setAttribute('fill', `hsl(${index * (360 / parts.length)}, 70%, 60%)`);
                    rect.setAttribute('stroke', htmlElement.classList.contains('dark') ? '#27272a' : '#fff'); /* Zinc 800 for dark mode stroke */
                    rect.setAttribute('stroke-width', '1');
                    rect.setAttribute('data-part-index', index);

                    rect.classList.add('cursor-pointer', 'transition-all', 'duration-100', 'ease-in-out');

                    rect.addEventListener('mouseover', () => {
                        const targetPart = outputContainer.children[index];
                        if (targetPart) {
                            targetPart.classList.add('ring-4', 'ring-blue-300', 'ring-offset-2');
                        }
                    });
                    rect.addEventListener('mouseout', () => {
                        const targetPart = outputContainer.children[index];
                        if (targetPart) {
                            targetPart.classList.remove('ring-4', 'ring-blue-300', 'ring-offset-2');
                        }
                    });
                     rect.addEventListener('click', () => {
                        const targetPart = outputContainer.children[index];
                        if (targetPart) {
                            targetPart.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    });


                    splitMapSvg.appendChild(rect);
                    currentX += width;
                });
            }


            // --- Persistence (localStorage) ---
            function saveState() {
                const state = {
                    inputText: inputText.value,
                    splitMethod: splitMethodSelect.value,
                    numParts: numPartsInput.value,
                    maxChars: maxCharsInput.value,
                    customDelimiter: customDelimiterInput.value,
                    templateSelector: templateSelector.value,
                };
                localStorage.setItem('splitterAppState', JSON.stringify(state));
            }

            function loadState() {
                const savedState = localStorage.getItem('splitterAppState');
                if (savedState) {
                    const state = JSON.parse(savedState);
                    inputText.value = state.inputText || '';
                    splitMethodSelect.value = state.splitMethod || 'numParts';
                    numPartsInput.value = state.numParts || '2';
                    maxCharsInput.value = state.maxChars || '1000';
                    customDelimiterInput.value = state.customDelimiter || '';
                    templateSelector.value = state.templateSelector || 'none';

                    toggleSplitMethodInputs();
                    updateLivePreviews();
                }
            }

            // --- Handle URL Parameters for Sharing ---
            function loadFromUrlParams() {
                const params = new URLSearchParams(window.location.search);
                const sharedText = params.get('text');
                const sharedMethod = params.get('method');
                const sharedNumParts = params.get('numParts');
                const sharedMaxChars = params.get('maxChars');
                const sharedDelimiter = params.get('delimiter');

                if (sharedText) {
                    inputText.value = decodeURIComponent(sharedText);
                    if (sharedMethod) splitMethodSelect.value = sharedMethod;
                    if (sharedNumParts) numPartsInput.value = sharedNumParts;
                    if (sharedMaxChars) maxCharsInput.value = sharedMaxChars;
                    if (sharedDelimiter) customDelimiterInput.value = decodeURIComponent(sharedDelimiter);

                    toggleSplitMethodInputs();
                    updateLivePreviews();
                    // Optionally, trigger split directly after loading from URL
                    // splitButton.click();
                    showMessage('Content loaded from shared link!', 'info');
                    // Clear URL params to avoid re-loading on refresh
                    history.replaceState({}, document.title, window.location.pathname);
                }
            }

            // --- Onboarding Logic ---
            function showWelcomeMessage() {
                const hasVisited = localStorage.getItem('hasVisitedSplitter');
                if (!hasVisited) {
                    welcomeMessage.classList.remove('hidden');
                    setTimeout(() => {
                        welcomeMessage.classList.remove('opacity-0', 'scale-95');
                        welcomeMessage.classList.add('opacity-100', 'scale-100');
                    }, 100);

                    dismissWelcomeButton.addEventListener('click', () => {
                        welcomeMessage.classList.remove('opacity-100', 'scale-100');
                        welcomeMessage.classList.add('opacity-0', 'scale-95');
                        setTimeout(() => {
                            welcomeMessage.classList.add('hidden');
                            localStorage.setItem('hasVisitedSplitter', 'true');
                        }, 500);
                    });
                }
            }


            // --- Initialize on Load ---
            loadState(); // Load user's last state
            loadFromUrlParams(); // Override if URL params exist (shared link)
            toggleSplitMethodInputs();
            updateLivePreviews();
            renderRecentSessions(); // Load and display recent sessions on startup
            detectAndSuggestTextType(); // Initial detection on load
            showWelcomeMessage(); // Show welcome message for first-time users
        });
    </script>
</body>
</html>
